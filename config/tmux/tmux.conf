# tmux.conf
# KORA ¬∑ TMUX Configuration (Grim√≥rio Neo-Noir)
#
# Um ambiente Tmux minimalista e coeso, projetado para produtividade e uma est√©tica
# "grim√≥rio neo-noir". Integra√ß√£o profunda com Neovim e Sesh para um workflow fluido.
#
# Prefixo: `C-a` (Ctrl+a)

# Source color palette and reset file
source-file ~/.config/tmux/colors.conf
source-file ~/.config/tmux/tmux.reset.conf

# Core Configuration
set -g default-terminal "xterm-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -g base-index 1
set -g detach-on-destroy off
set -g escape-time 0
set -g history-limit 1000000
set -g mouse on
set -g renumber-windows on
set -g set-clipboard on
set -g status-interval 3
setw -g mode-keys vi
set -g focus-events on
set -g allow-passthrough on # Allow applications to handle keypresses directly

# Status Bar (Grim√≥rio Neo-Noir)
set -g status-position top
set -g status-style 'bg=default' # transparent
set -g status-left-length 300

# Left side: Session name and gitmux
set -g status-left "#[fg=$grimorio_neon_purple,bold]Û∞£á #S #[fg=$grimorio_text,nobold]#(gitmux -cfg $HOME/.config/tmux/gitmux.yml) "

# Right side: Time
set -g status-right "#[fg=$grimorio_neon_cyan,bold]Û∞•î %H:%M "

# Window status
set -g window-status-current-format '#[fg=$grimorio_bg,bg=$grimorio_neon_purple,bold] #I Û∞ñ≤ #W '
set -g window-status-format '#[fg=$grimorio_muted] #I Û∞ñ≤ #W '

# Pane Borders
set -g pane-active-border-style "fg=$grimorio_neon_blue"
set -g pane-border-style "fg=$grimorio_dim"

# Communication System (Messages & Modes)
set -g message-command-style "bg=default,fg=$grimorio_neon_yellow"
set -g message-style "bg=default,fg=$grimorio_neon_yellow"
set -g mode-style "bg=$grimorio_neon_purple,fg=$grimorio_bg"

# Sesh Integration with fzf-tmux (Grim√≥rio Style)
# Note: The fzf-tmux command is complex. The colors are set to match the grimorio theme.
# Color mapping: list-border:6 (cyan), input-border:3 (yellow), preview-border:4 (blue), header-bg:-1 (default), header-border:6 (cyan)
FZF_GRIMOIRE_COLORS="--color \"list-border:$grimorio_neon_cyan,input-border:$grimorio_neon_yellow,preview-border:$grimorio_neon_blue,header-bg:-1,header-border:$grimorio_neon_cyan,hl:$grimorio_neon_green,hl+:$grimorio_neon_green\""


bind-key "K" run-shell "sesh connect \"$( \
  sesh list --icons --hide-duplicates | fzf-tmux -p 100%,100% --no-border \
    --ansi \
    --list-border \
    --no-sort --prompt '‚ö°  ' \
    $FZF_GRIMOIRE_COLORS \
    --input-border \
    --header-border \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-b:abort' \
    --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ÓØà  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --preview-window 'right:70%' \
    --preview 'sesh preview {}' \
)\""

bind-key "N" display-popup -E "sesh ui" # Original bind from user's paste

bind-key "R" run-shell "sesh connect \"$( \
  sesh list --icons | fzf-tmux -p 100%,100% --no-border \
    --query  \"$(sesh root)\" \
    --ansi \
    --list-border \
    --no-sort --prompt '‚ö°  ' \
    $FZF_GRIMOIRE_COLORS \
    --input-border \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-b:abort' \
    --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --preview-window 'right:70%' \
    --preview 'sesh preview {}' \
)\""

# Other Keybindings from user's config (adjusted for grimorio style and valid syntax)
bind % split-window -c '#{pane_current_path}' -h
bind '"' split-window -c '#{pane_current_path}'
bind c new-window -c '#{pane_current_path}'

bind -N "last-session (via sesh)" L run-shell "sesh last || tmux display-message -d 1000 'Only one session'"
bind -N "switch to root session (via sesh)" 9 run-shell "sesh connect --root $(pwd)"

bind -N "ai (claude)" A split-window -h -c "#{pane_current_path}" "claude"
bind -N "lazygit" g new-window -c "#{pane_current_path}" -n "üå≥" "lazygit 2> /dev/null"
bind -N "git commit (raycast)" G new-window -c "#{pane_current_path}" -n "üîí" "raycast-git-commit.sh"
bind -N "build (via sesh)" b new-window -c "#{pane_current_path}" -n üî® "sesh build"
bind -N "dev" D split-window -v -l 10 dev
bind -N "run a script" Y split-window -v -l 10 "npm run (jq -r '.scripts | keys[]' package.json | fzf --no-border)"
bind -N "kill current session" Q kill-session
bind -N "break pane" B break-pane
bind -N "join pane" J join-pane -t 1
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'v' send-keys -X begin-selection
bind-key x kill-pane # skip "kill-pane 1? (y/n)" prompt (cmd+w)
bind-key e send-keys "tmux capture-pane -p -S - | nvim -c 'set buftype=nofile' +" Enter

# Plugins (TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'joshmedeski/tmux-fzf-url'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'
set -g @plugin 'joshmedeski/tmux-voice-mode'
set -g @plugin 'joshmedeski/vim-tmux-navigator'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'rickstaa/tmux-notify'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'omerxx/tmux-floax'

# Plugin Settings
set -g @fzf-url-fzf-options '-p 60%,30% --prompt="ÔÇé   " --border-label=" Open URL "'
set -g @fzf-url-history-limit '2000'
set -g @thumbs-command 'echo -n {} | pbcopy'
set -g @thumbs-key 'C'
set -g @floax-bind 'p'
set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-border-color "$grimorio_neon_purple"
set -g @floax-text-color "$grimorio_neon_cyan"
set -g @sessionx-bind 'o'
set -g @sessionx-window-height '85%'
set -g @sessionx-window-width '75%'
set -g @sessionx-zoxide-mode 'on'

# Automatic window renaming with nerd font icons
set -g @tmux-nerd-font-window-name-shell-icon 'ÔÅî'
set -g @tmux-nerd-font-window-name-show-name false
set -g @tmux-nerd-font-window-name-config-file "$HOME/.config/tmux/tmux-nerd-font-window-name.yml"
set-option -g automatic-rename-format '#(tmux-nerd-font-window-name #{pane_current_command} #{window_panes}) #{b:pane_current_path}'

# TPM Initialization (must be at the end)
run "$HOME/.config/tmux/plugins/tpm/tpm"
