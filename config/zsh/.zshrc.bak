# ~/.config/zsh/.zshrc — KORA v3 Loader (Mise Edition)
# Este arquivo orquestra o carregamento de todas as partes do shell.

# -- Performance Marker
typeset -F SECONDS
export KORA_STARTUP_BEGIN=$SECONDS

# -- Definição do ZDOTDIR (essencial, deve ser o primeiro)
export ZDOTDIR="${XDG_CONFIG_HOME:-$HOME/.config}/zsh"

# -- Carregamento Modular
# A ordem aqui é importante para garantir que o ambiente e os plugins
# funcionem corretamente.

# 1. Variáveis de Ambiente e PATH (essencial para encontrar executáveis)
[[ -r "$ZDOTDIR/modules/env.zsh" ]] && source "$ZDOTDIR/modules/env.zsh"

# 2. Plugins (inclui Zinit bootstrap)
[[ -r "$ZDOTDIR/modules/plugins.zsh" ]] && source "$ZDOTDIR/modules/plugins.zsh"

# 3. Configurações do Core do Zsh (Opções e Completions)
[[ -r "$ZDOTDIR/modules/core.zsh" ]] && source "$ZDOTDIR/modules/core.zsh"

# 4. Aliases e Funções
[[ -r "$ZDOTDIR/modules/aliases.zsh" ]] && source "$ZDOTDIR/modules/aliases.zsh"
if [[ -d "$ZDOTDIR/modules/functions" ]]; then
  for f in "$ZDOTDIR/modules/functions"/*.zsh(N); do
    source "$f"
  done
fi

# 5. TUI (Keybindings e Estilos de Ferramentas)
[[ -r "$ZDOTDIR/modules/spellbook.zsh" ]] && source "$ZDOTDIR/modules/spellbook.zsh"

# 6. Keybindings
[[ -r "$ZDOTDIR/modules/keybinds.zsh" ]] && source "$ZDOTDIR/modules/keybinds.zsh"

# 7. Gerenciador de Ambientes (Mise)
# Ativa o mise para gerenciar versões de node, python, etc.
if command -v mise &> /dev/null; then
  eval "$(mise activate zsh)"
fi

# 8. Prompt (Oh My Posh)
# Carregado por último para ter acesso a todo o contexto.
[[ -r "$ZDOTDIR/modules/prompt.zsh" ]] && source "$ZDOTDIR/modules/prompt.zsh"

# -- Performance Marker End
if [[ -n "$KORA_STARTUP_BEGIN" ]]; then
  export KORA_STARTUP_END=$SECONDS
  local startup_time=$((KORA_STARTUP_END - KORA_STARTUP_BEGIN))
  # echo "KORA: startup took ${startup_time}s"
fi